<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HCAI OPS | Alerts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" />
  <style>[x-cloak]{display:none !important;}</style>
  <link rel="stylesheet" href="/web/style.css" />
  <script src="/web/nav.js"></script>
  <script>
    function alertsPage() {
        return {

            alerts: [],
            expanded: {},

            filters: {
                severity: "",
                search: ""
            },

            count: {
                CRITICAL: 0,
                ERROR: 0,
                WARNING: 0,
                INFO: 0
            },

            get filteredAlerts() {
                return this.alerts.filter(a => {
                    let ok = true;

                    if (this.filters.severity) {
                        if (a.severity !== this.filters.severity)
                            ok = false;
                    }

                    if (this.filters.search) {
                        const q = this.filters.search.toLowerCase();
                        if (
                            !a.message.toLowerCase().includes(q) &&
                            !a.source_id.toLowerCase().includes(q)
                        ) {
                            ok = false;
                        }
                    }

                    return ok;
                });
            },

            severityColor(level) {
                return {
                    CRITICAL: "bg-red-600 text-white",
                    ERROR: "bg-orange-500 text-white",
                    WARNING: "bg-yellow-400 text-gray-900",
                    INFO: "bg-blue-500 text-white"
                }[level] || "bg-gray-300 text-black";
            },

            toggleExpand(id) {
                this.expanded[id] = !this.expanded[id];
            },

            acknowledge(id) {
                // no backend call for now
                console.log("Acknowledged alert:", id);
            },

            updateCounters() {
                this.count = {
                    CRITICAL: this.alerts.filter(a => a.severity === "CRITICAL").length,
                    ERROR: this.alerts.filter(a => a.severity === "ERROR").length,
                    WARNING: this.alerts.filter(a => a.severity === "WARNING").length,
                    INFO: this.alerts.filter(a => a.severity === "INFO").length
                };
            },

            async fetchAlerts() {
                let res = await fetch("/alerts/recent");
                let data = await res.json();

                this.alerts = Array.isArray(data) ? data : [];
                this.updateCounters();
            },

            init() {
                this.fetchAlerts();
                setInterval(() => this.fetchAlerts(), 10000);
            }
        }
    }
  </script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
</head>
<body class="page-bg text-slate-900 min-h-screen">

<div class="page-shell">
  <div id="global-nav" class="mb-6"></div>
  <script>injectNav('global-nav', 'alerts');</script>
<div class="panel flex items-center justify-between mb-6 px-4 py-3">
  <div class="flex items-center gap-3">
    <div class="h-10 w-10 rounded-xl bg-rose-100 border border-rose-200 flex items-center justify-center text-rose-600 font-bold">H</div>
    <div>
      <p class="text-xs text-slate-500 tracking-wide">HCAI OPS</p>
      <p class="text-lg font-semibold text-slate-900">Active Alerts Board</p>
    </div>
  </div>
  <span class="inline-flex items-center px-3 py-1 rounded-full bg-white border border-slate-200 shadow-sm text-xs text-slate-600">Live refresh</span>
</div>

<div x-data="alertsPage()" class="space-y-5">

    <!-- Header -->
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-slate-900">Active Alerts</h2>

        <button @click="fetchAlerts"
            class="px-4 py-2 bg-rose-600 hover:bg-rose-500 text-white rounded-lg shadow-sm text-sm font-semibold transition">
            Refresh
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-slate-200 shadow-sm rounded-xl p-4 flex flex-wrap gap-4">

        <!-- Severity -->
        <div class="flex flex-col">
            <label class="text-sm text-slate-700">Severity</label>
            <select x-model="filters.severity"
                    class="border border-slate-300 bg-white rounded px-3 py-2 text-sm text-slate-900 focus:ring-2 focus:ring-rose-500">
                <option value="">All</option>
                <option value="CRITICAL">Critical</option>
                <option value="ERROR">Error</option>
                <option value="WARNING">Warning</option>
                <option value="INFO">Info</option>
            </select>
        </div>

        <!-- Search -->
        <div class="flex flex-col">
            <label class="text-sm text-slate-700">Search</label>
            <input type="text"
                placeholder="Search message or sourceâ€¦"
                x-model="filters.search"
                class="border border-slate-300 bg-white rounded px-3 py-2 w-64 text-sm text-slate-900 focus:ring-2 focus:ring-rose-500 placeholder:text-slate-400">
        </div>
    </div>

    <!-- Alert Counters -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">

        <div class="bg-rose-500 text-white p-4 rounded-xl shadow-sm text-center border border-rose-500/20">
            <p class="text-sm">Critical</p>
            <p class="text-2xl font-bold" x-text="count.CRITICAL"></p>
        </div>

        <div class="bg-orange-500 text-white p-4 rounded-xl shadow-sm text-center border border-orange-500/20">
            <p class="text-sm">Error</p>
            <p class="text-2xl font-bold" x-text="count.ERROR"></p>
        </div>

        <div class="bg-yellow-300 text-slate-900 p-4 rounded-xl shadow-sm text-center border border-yellow-300/40">
            <p class="text-sm">Warning</p>
            <p class="text-2xl font-bold" x-text="count.WARNING"></p>
        </div>

        <div class="bg-sky-500 text-white p-4 rounded-xl shadow-sm text-center border border-sky-500/20">
            <p class="text-sm">Info</p>
            <p class="text-2xl font-bold" x-text="count.INFO"></p>
        </div>
    </div>

    <!-- Alerts List -->
    <div class="space-y-3">

        <template x-for="alert in filteredAlerts" :key="alert.alert_id">

            <div class="border border-slate-200 rounded-xl shadow-sm bg-white p-4">

                <div class="flex items-center justify-between">

                    <div class="flex flex-col">
                        <span class="font-semibold text-lg text-slate-900"
                              x-text="alert.message"></span>

                        <span class="text-xs text-slate-500 mt-1"
                              x-text="alert.timestamp"></span>

                        <span class="text-xs text-slate-500"
                              x-text="'Source: ' + alert.source_id"></span>
                    </div>

                    <!-- Severity Badge -->
                    <span class="px-2 py-1 rounded text-xs font-bold"
                          :class="severityColor(alert.severity)"
                          x-text="alert.severity">
                    </span>
                </div>

                <!-- Expand Button -->
                <button class="mt-3 text-rose-600 underline text-xs hover:text-rose-500"
                        @click="toggleExpand(alert.alert_id)">
                    View Details
                </button>

                <!-- Details -->
                <div x-show="expanded[alert.alert_id]"
                     class="mt-2 bg-slate-50 rounded-lg p-3 text-xs border border-slate-200">

                    <pre class="whitespace-pre-wrap text-slate-800"
                         x-text="JSON.stringify(alert.metadata, null, 2)">
                    </pre>

                    <button class="mt-2 px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-900 rounded text-xs border border-slate-200"
                            @click="acknowledge(alert.alert_id)">
                        Acknowledge
                    </button>
                </div>

            </div>

        </template>

    </div>

</div>

</div>

</div>

</body>
</html>
