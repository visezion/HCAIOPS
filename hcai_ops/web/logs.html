<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HCAI OPS | System Logs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" />
  <style>[x-cloak]{display:none !important;}</style>
  <script>
    function logsPage() {
        return {

            logs: [],
            expanded: {},

            filters: {
                level: "",
                search: ""
            },

            count: {
                CRITICAL: 0,
                ERROR: 0,
                WARNING: 0,
                INFO: 0,
                DEBUG: 0
            },

            get filteredLogs() {
                return this.logs.filter(l => {
                    let ok = true;

                    if (this.filters.level) {
                        if (l.log_level !== this.filters.level)
                            ok = false;
                    }

                    if (this.filters.search) {
                        const s = this.filters.search.toLowerCase();
                        if (
                            !l.log_message.toLowerCase().includes(s) &&
                            !l.source_id.toLowerCase().includes(s) &&
                            !(l.extras?.raw_header || "").toLowerCase().includes(s)
                        ) {
                            ok = false;
                        }
                    }

                    return ok;
                });
            },

            levelColor(level) {
                return {
                    CRITICAL: "bg-red-600 text-white",
                    ERROR: "bg-orange-500 text-white",
                    WARNING: "bg-yellow-400 text-gray-900",
                    INFO: "bg-blue-500 text-white",
                    DEBUG: "bg-gray-700 text-white"
                }[level] || "bg-gray-300 text-black";
            },

            toggleExpand(id) {
                this.expanded[id] = !this.expanded[id];
            },

            updateCounters() {
                this.count = {
                    CRITICAL: this.logs.filter(l => l.log_level === "CRITICAL").length,
                    ERROR: this.logs.filter(l => l.log_level === "ERROR").length,
                    WARNING: this.logs.filter(l => l.log_level === "WARNING").length,
                    INFO: this.logs.filter(l => l.log_level === "INFO").length,
                    DEBUG: this.logs.filter(l => l.log_level === "DEBUG").length
                };
            },

            async fetchLogs() {
                let res = await fetch("/logs/recent");
                let data = await res.json();

                this.logs = Array.isArray(data) ? data : [];
                this.updateCounters();
            },

            init() {
                this.fetchLogs();
                setInterval(() => this.fetchLogs(), 10000);
            }
        }
    }
  </script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

<div class="max-w-6xl mx-auto px-4 py-8">
<div class="flex items-center justify-between mb-6">
  <div class="flex items-center gap-3">
    <div class="h-10 w-10 rounded-xl bg-sky-100 border border-sky-200 flex items-center justify-center text-sky-600 font-bold">H</div>
    <div>
      <p class="text-xs text-slate-500 tracking-wide">HCAI OPS</p>
      <p class="text-lg font-semibold text-slate-900">Systems Logs Center</p>
    </div>
  </div>
  <div class="flex items-center gap-3 text-xs text-slate-600">
    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white border border-slate-200 shadow-sm">Live</span>
  </div>
</div>

<div x-data="logsPage()" class="space-y-5">

    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-slate-900">System Logs</h2>

        <button @click="fetchLogs"
            class="px-4 py-2 bg-sky-600 hover:bg-sky-500 text-white rounded-lg shadow-sm text-sm font-semibold transition">
            Refresh
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-slate-200 rounded-xl p-4 flex flex-wrap gap-4 shadow-sm">

        <!-- Level Filter -->
        <div class="flex flex-col">
            <label class="text-sm text-slate-700">Log Level</label>
            <select x-model="filters.level"
                    class="border border-slate-300 bg-white rounded px-3 py-2 text-sm text-slate-900 focus:ring-2 focus:ring-sky-500">
                <option value="">All</option>
                <option value="CRITICAL">Critical</option>
                <option value="ERROR">Error</option>
                <option value="WARNING">Warning</option>
                <option value="INFO">Info</option>
                <option value="DEBUG">Debug</option>
            </select>
        </div>

        <!-- Search -->
        <div class="flex flex-col">
            <label class="text-sm text-slate-700">Search</label>
            <input type="text"
                placeholder="Search in logs..."
                x-model="filters.search"
                class="border border-slate-300 bg-white rounded px-3 py-2 w-64 text-sm text-slate-900 focus:ring-2 focus:ring-sky-500 placeholder:text-slate-400">
        </div>

    </div>

    <!-- Counters -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">

        <div class="bg-rose-500 text-white p-3 rounded-xl shadow-sm text-center border border-rose-500/20">
            <p class="text-xs">Critical</p>
            <p class="text-lg font-bold" x-text="count.CRITICAL"></p>
        </div>

        <div class="bg-orange-500 text-white p-3 rounded-xl shadow-sm text-center border border-orange-500/20">
            <p class="text-xs">Error</p>
            <p class="text-lg font-bold" x-text="count.ERROR"></p>
        </div>

        <div class="bg-yellow-300 text-slate-900 p-3 rounded-xl shadow-sm text-center border border-yellow-300/40">
            <p class="text-xs">Warning</p>
            <p class="text-lg font-bold" x-text="count.WARNING"></p>
        </div>

        <div class="bg-sky-500 text-white p-3 rounded-xl shadow-sm text-center border border-sky-500/20">
            <p class="text-xs">Info</p>
            <p class="text-lg font-bold" x-text="count.INFO"></p>
        </div>

        <div class="bg-slate-600 text-white p-3 rounded-xl shadow-sm text-center border border-slate-600/20">
            <p class="text-xs">Debug</p>
            <p class="text-lg font-bold" x-text="count.DEBUG"></p>
        </div>

    </div>

    <!-- Logs Table -->
    <div class="overflow-x-auto bg-white border border-slate-200 rounded-xl shadow-sm">

        <table class="w-full text-sm">
            <thead class="bg-slate-100 text-slate-800 border-b border-slate-200">
                <tr>
                    <th class="p-3 text-left font-semibold text-xs uppercase tracking-wide">Timestamp</th>
                    <th class="p-3 text-left font-semibold text-xs uppercase tracking-wide">Source</th>
                    <th class="p-3 text-left font-semibold text-xs uppercase tracking-wide">Level</th>
                    <th class="p-3 text-left font-semibold text-xs uppercase tracking-wide">Message</th>
                    <th class="p-3 text-left"></th>
                </tr>
            </thead>

        <tbody>

                <template x-for="log in filteredLogs" :key="log.timestamp + log.source_id">

                    <tr class="border-b border-slate-200 hover:bg-slate-50 transition">

                        <td class="p-3 text-slate-800" x-text="log.timestamp"></td>
                        <td class="p-3 text-slate-800" x-text="log.source_id"></td>

                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs font-bold"
                                :class="levelColor(log.log_level)"
                                x-text="log.log_level">
                            </span>
                        </td>

                        <td class="p-3 text-slate-900" x-text="log.log_message"></td>

                        <td class="p-3">
                            <button class="text-sky-600 underline text-xs hover:text-sky-500"
                                    @click="toggleExpand(log.timestamp + log.source_id)">
                                Details
                            </button>
                        </td>

                    </tr>

                    <!-- Expanded Raw Header -->
                    <tr x-show="expanded[log.timestamp + log.source_id]"
                        class="bg-slate-50">

                        <td colspan="5" class="p-3">
                            <pre class="text-xs whitespace-pre-wrap text-slate-800 bg-white p-3 rounded-lg border border-slate-200"
                                x-text="log.extras?.raw_header">
                            </pre>
                        </td>

                    </tr>

                </template>

            </tbody>
        </table>
    </div>

</div>

</div>

</body>
</html>
